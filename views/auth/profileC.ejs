<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Complete Your Profile</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
      }
      .container {
        max-width: 800px;
        margin: 50px auto;
        background-color: #ffffff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #007bff;
        text-align: center;
        font-size: 2.5rem;
      }
      p {
        color: #555;
        font-size: 1.1rem;
        line-height: 1.6;
        text-align: justify;
      }
      label {
        font-size: 1.1rem;
        font-weight: bold;
        color: #333;
      }
      select {
        width: 100%;
        padding: 10px;
        margin: 10px 0 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 1rem;
      }
      .info-box {
        background-color: #e9f7fe;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #b3e0f2;
        margin-bottom: 20px;
      }
      .info-box h3 {
        margin: 0;
        color: #007bff;
      }
      button {
        width: 100%;
        padding: 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 1.1rem;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      .footer-text {
        text-align: center;
        font-size: 0.9rem;
        color: #777;
      }
      .warning-box {
        background-color: #fff3cd;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #ffeeba;
        margin-bottom: 20px;
      }
      .warning-box h3 {
        margin: 0;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Complete Your Profile</h1>
      <p>
        Welcome to our platform! To provide you with the best possible
        experience, please complete your profile by selecting your role. This
        step helps us understand how we can assist you better and connect you
        with relevant opportunities.
      </p>
      <p>
        Please select your role below. Your role will determine the features and
        services available to you on the platform. If you're unsure about which
        role to choose, feel free to reach out to our support team for
        assistance.
      </p>

      <div class="info-box">
        <h3>Why is this important?</h3>
        <p>
          By selecting a role, we can personalize your experience on the
          platform. Whether you're a <strong>worker</strong> or a
          <strong>client</strong>, this helps us tailor the content and tools
          you need to succeed.
        </p>
      </div>

      <!-- Warning Box (hidden by default) -->
      <div id="warningBox" class="warning-box" role="alert">
        <h3>Important:</h3>
        <p>
          If you change your role, please do not refresh the page or navigate
          away. Doing so might cause a server error. Once you submit your role,
          the changes will be processed, and you will be redirected.
        </p>
      </div>

      <!-- Alert Box (hidden by default) -->
      <div id="alertBox" class="alert alert-danger d-none" role="alert">
        Please select a role.
      </div>

      <form id="profileForm">
        <div class="form-group">
          <label for="role">Select Your Role:</label>
          <select class="form-control" name="role" id="role" required>
            <option value="">-- Select Role --</option>
            <option value="worker">Worker</option>
            <option value="client">Client</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary">Submit</button>
      </form>

      <p class="footer-text">
        If you need help, please contact our support team.
      </p>
    </div>

    <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
      document
        .getElementById("profileForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault(); // Prevent the default form submission

          const role = document.getElementById("role").value;
          const alertBox = document.getElementById("alertBox");
          const warningBox = document.getElementById("warningBox");

          if (!role) {
            // Show the alert if no role is selected
            alertBox.classList.remove("d-none");
            return;
          } else {
            // Hide the alert if a role is selected
            alertBox.classList.add("d-none");
          }

          const userId = "<%= userId %>"; // Use the passed userId from the server-side

          // Show the warning box about refreshing the page
          warningBox.classList.remove("d-none");

          try {
            const response = await fetch(`/home/fillRole/${userId}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ role }),
            });

            const result = await response.json();

            if (response.ok) {
              // Show success alert
              const successAlert = document.createElement("div");
              successAlert.classList.add("alert", "alert-success");
              successAlert.role = "alert";
              successAlert.innerHTML =
                result.message || "Role updated successfully.";
              document.body.insertBefore(
                successAlert,
                document.querySelector(".container")
              );
              // Scroll the user to the top of the page to see the alert
              window.scrollTo({
                top: 0,
                behavior: "smooth", // Smooth scrolling to the top
              });
              setTimeout(() => successAlert.remove(), 2000); // Remove success alert after 3 seconds

              setTimeout(() => {
                window.location.href = "/"; // Redirect to the login page
              }, 3000);
            } else {
              // Handle errors from the server (e.g., validation errors)
              const errorMessages =
                result.errors?.join("\n") || "An error occurred.";
              const errorAlert = document.createElement("div");
              errorAlert.classList.add("alert", "alert-danger");
              errorAlert.role = "alert";
              errorAlert.innerHTML = `Error: ${errorMessages}`;
              document.body.insertBefore(
                errorAlert,
                document.querySelector(".container")
              );
              setTimeout(() => errorAlert.remove(), 3000); // Remove error alert after 3 seconds
              window.scrollTo({
                top: 0,
                behavior: "smooth", // Smooth scrolling to the top
              });
            }
          } catch (error) {
            // Handle network or unexpected errors (client-side errors)
            const errorAlert = document.createElement("div");
            errorAlert.classList.add("alert", "alert-danger");
            errorAlert.role = "alert";
            errorAlert.innerHTML = `Client-Side Error: An unexpected error occurred: ${error.message}`;
            document.body.insertBefore(
              errorAlert,
              document.querySelector(".container")
            );
            setTimeout(() => errorAlert.remove(), 3000); // Remove error alert after 3 seconds

            window.scrollTo({
              top: 0,
              behavior: "smooth", // Smooth scrolling to the top
            });
          }
        });
    </script>
  </body>
</html>
